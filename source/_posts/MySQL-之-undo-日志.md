---
title: MySQL 之 undo 日志
date: 2020-06-18 19:37:58
tags: MySQL
categories: MySQL
---

之前我们已经讲了在执行增删改操作时候的 redo log 的重做日志原理，说白了就是你对 buffer pool 里的缓存页执行增删改操作的时候，必须要写对应的 redo log 记录下来你做了哪些修改。而 redo log 都是先进入 redo log buffer 中的一个 block，然后事务提交的时候就会刷入磁盘文件里去。这样万一你提交事务了，结果事务修改的缓存页还没来得及刷入磁盘上的数据文件，此时你 MySQL 关闭了或者是宕机了，那么 buffer pool 里被事务修改的数据就全部丢失了



但是只要有 redo log，你重启 MySQL 之后完全是可以把那些修改了缓存页，但是缓存页还没来得及刷入磁盘的事务，它们对应的 redo log 都加载出来，在 buffer pool 的缓存页里重做一遍，就可以保证事务提交之后，修改的数据绝对不会丢失。



接着我们来讲另外一种日志，就是 undo log 日志，即回滚日志。这种日志要应对的场景，就是事务回滚的场景。



假设现在我们一个事务里要执行一些增删改的操作，那么必然是先把对应的数据页从磁盘加载出来放 buffer pool 的缓存页里，然后在缓存页里执行一遍增删改，同时记录 redo log 日志。如下：

![MySQL](MySQL-之-undo-日志/MySQL.png)



但是万一一个事务的一通增删改操作执行了一半，结果就回滚事务了呢？比如一个事务里有 4 个增删改操作，结果目前为止已经执行了 2 个增删改 SQL 了，已经更新了一些 buffer pool 里的数据了，但是还有 2 个增删改 SQL 的逻辑还没执行，此时事务回滚了，咋整？



这个时候就很尴尬了，如果你要回滚事务的话，那么必须要把已经在 buffer pool 的缓存页里执行的增删改操作给回滚了。但是要怎么回滚呢？无论是插入、更新还是删除，该做的都已经做了。所以在执行的时候，必须引入另外一种日志，就是 undo log 回滚日志。



这个回滚日志，它记录的东西其实非常简单。比如你要是在缓存里执行了一个 insert 语句，那么此时你在 undo log 日志里，对这个操作记录的回滚日志就必须是有一个主键和一个对应的 delete 操作，要能让你把这次 insert 操作给回退了。



你要是执行的是 delete 语句，那么起码你要把你删除的那条数据记录下来，如果要回滚，就应该执行一个 insert 操作把那条数据插入回去；如果你执行的是 update 语句，那么起码你要把那个更新之前的那个值记录下来，回滚的时候重新 update 一下，把你之前更新前的旧值给他更新回去。如果执行的是 select 呢？select 语句根本没有在 buffer pool 里执行任何修改，所以根本不需要 undo log。



所以你除了写 redo log 日志还必须要写 undo log 日志，这个 undo log 日志是至关重要的，没有它你都没办法回滚日志。

![写回滚日志](MySQL-之-undo-日志/写回滚日志.png)



