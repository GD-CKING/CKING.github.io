---
title: 上亿数据量的用户表如何进行水平拆分
date: 2020-11-24 18:28:00
tags: MySQL
categories: MySQL
---

今天我们只讲解分库分表的整体方案设计，但是在进行具体的方案落地的时候，是需要数据库中间件技术的支持的，业内常用的一般有 `Sharding - Sphere` 以及 `MyCat` 两种，各自用的公司也很多，你们可以自行选择一个数据库中间件技术，熟悉一下它们的用法



今天要说的是海量用户数据的分库分表的方案。一般公司都会有个用户中心，而且用户中心就是负责所有用户的数据管理，包括了用户的数据存储，用户信息的增删改查，用户注册登录等等。我们的背景就是这么一个亿级数据量的用户表



首先，一般面对这么一个几千万级的数据，刚开始可能都是把数据库放在 MySQL 的一个单库单表里的，但是这么大量级的数据到了后期，会搞的数据库查询速度很慢。因为数据量级太大，会导致表的索引很大，树的层级很高，进而导致搜索性能下降，而且能放内存缓存的数据页是比较少的



因此，我们都建议 MySQL 单表数据量不要超过 1000 万，最好是在 500 万以内，如果能控制在 100 万以内，那是最佳的选择。基本单表 100 万以内的数据，性能上不会有太大的问题，前提是，只要你建好索引就行。其实保证 MySQL 高性能通常没什么特别高深的技巧，就是控制数据量不要太大，还有就是保证你的查询用上了索引，一般就没问题



针对这个问题，我们就可以进行分库分表了，可以选择把这个用户大表拆分为 100 张表，此时几千万数据瞬间分散到 100 个表里去，类似 user_001、user_002、user_100 这样的 100 个表，每个表也就几十万数据而已



其次，可以把这 100 个表分散到多台数据库服务器上去，那么要分散到几台服务器呢？要考虑两个点，一个是数据量有多少个 GB/TB，一个是针对用户中心的并发压力有多高。实际上用户中心的压力不会高的太离谱，因为一般不会有很多人同时登陆 / 注册，或者同时修改自己的个人信息，所以并发这块不是太大问题



数据量层面，给大家一个经验值，一般 1 亿行数据，大致在 1GB 到几个 GB 之间的范围，具体跟你一行数据有多少字段也有关系，大致就是这个范围，所以你几千万的用户数据，往多了说也就几个 GB 而已，这点数据量，对于服务器的存储空间来说，完全没压力



综上，你完全可以给他分配两台数据库服务器，放两个库，然后 100 张表均匀分散在 2 台服务器上就可以了。分的时候要指定一个字段来分，一般会指定 `userId`，根据用户 id 进行 hash 之后，对表进行取模，路由到一个表里去，这样可以让数据均匀分散



到此就搞定了用户表的分库分表，只要给系统加上数据库中间件技术，设置好路由规则，就可以轻松地对 2 个分库上的 100 张表进行增删改查的操作了。平时针对某个用户增删改查，直接对他的 `userId` 进行 hash，然后对表取模，做一个路由，就知道到哪个表里去找这个用户的数据了



但是，会出现一些问题。例如，用户在登陆的时候，可能不是根据哪个 `userId` 登陆的，可能是根据 `username` 之类的用户名、手机号之类的来登陆的，此时你又没有 userId，怎么知道去哪个表里找这个用户的数据判断是否能登陆？



对于这个问题，一般来说就是建立一个索引映射表。就是搞一个表结构为`（username, userId）`的索引映射表，把 username 和 userId 一一映射，然后针对 username 再做一次分库分表，把这个索引映射表拆分为比如 100 个表分散在两台服务器里



接着用户登陆的时候，就可以根据 username 先去索引映射表里查找对应的 userId，比如对 username 进行 hash 然后取模到一个表里，找到 username 对应的 userId，接着根据 userId 进行 hash 再取模，然后路由到按照 userId分库分表里的一个表里去，找到用户的完整数据即可



但是这种方式会把一次查询转化为两个表的两次查询，先查索引映射表，再根据 userId 去查具体的数据，性能上是有一定的损耗的，不过有时候为了解决分库分表的问题，也只用用这种类似的方法



另外就是如果在公司运营团队里，有一个用户管理模块，需要对公司的用户按照手机号、地址、年龄、性别、职业等各种条件进行极为复杂的搜索，怎么处理？其实没太多的好办法，基本上就是要你对你的用户数据表进行 binlog 监听，把你要搜索的所有字段同步到 Elasticsearch 里去，建立好搜索的索引，然后你的运营系统就可以通过 Elasticsearch 去进行复杂的多条件搜索。ES 是适合干这个事情的，然后定位到一批 userId，通过 userId 回到分库分表环境里去找出具体的用户数据，在页面上展示出来即可



