---
title: 分库分表案例
date: 2020-11-30 14:49:34
tags: MySQL
categories: MySQL
---

假设有这么一个订单系统，每天新增数据大概是 1W 左右，每个月是新增 30W 数据，每年是新增 360W 数据，那么最多 3 年就到千万级大表了，这个就会导致你涉及订单的操作，速度挺慢的。



所以要做分库分表。订单表在拆分的时候，往往要考虑三个维度。一个是要按照订单 id 为粒度去分库分表，也就是把订单 id 进行 hash 之后，对表数量进行取模然后把订单数据均匀分散到 100 ~ 1000 个表里，再把这些表分散在多台服务器上



另外两个维度是用户端和运营端。用户端，就是用户可能要查自己的订单，运营端就是公司可能要查所有订单，如何解决这类问题？基本上针对用户端，需要按照（userid, orderid）这个表结构，去做一个索引映射表。userid 和 orderid 的一一对应关系要放在这个表里，然后针对 userid 为粒度去进行分库分表，也就是对 userid 进行 hash 后取模，然后把数据均匀分散在很多索引映射表里，再把表放在很多数据库里



然后每次客户端拿出 APP 查询自己的订单，直接根据 userid 去 hash 然后取模路由到一个索引映射表，找到这个用户的 orderid，这里可以做一个分页，因为一般订单都是支持分页的，此时可以允许用户分页查询 orderid，然后拿到一堆 orderid，再根据 orderid 去按照 orderid 粒度分库分表的表里提取订单完整数据



至于运营端，一般都是要根据 N 多条件对订单进行搜索的，此时根上次讲的一样，可以把订单数据的搜索条件都同步到 ES 里，然后用 ES 来进行复杂搜索，找出来一波 orderid，再根据 orderid 去分库分表里找订单完整数据



基本分库分表的玩法都是这套思路，按业务 id 分库分表，建立索引映射表同时进行分库分表，数据同步到 ES 做复杂搜索，基本这套玩法就可以保证你的分库分表场景下，各种业务功能都可以支撑



## 跨库的分页操作

接着是关于分库分表后的跨库 / 跨表的分页问题，例如之前的那个订单场景，假设用户现在要查询自己的订单，同时订单要求要支持分页，怎么实现？



其实按我们之前说的，基本上你只要按照 userid 先去分库分表的（userid, orderid）索引映射表里查找到你的那些 orderid，然后搞一个分页就可以了。对分页内的 orderid，每个 orderid 都得去按 orderid 分库分表的数据里查找完整的订单数据，这就可以搞定分库分表环境下的分页问题



这仅仅只是一个例子，告诉你的是，如果要在分库分表下搞分页，最好是保证你的一个主数据粒度（比如 userid）是你的分库分表的粒度，你可以根据一个业务 id 路由到一个表找到他的全部数据，这就可以做分页了



如果我想对用户下的订单做分页，同时还能指定一些查询条件呢？这其实也是很多 APP 都支持的，就是对自己的订单查询，有的 APP 是支持指定一些条件的，例如订单名称模糊搜索。例如，在我的订单界面，可以按照订单状态来搜索，分别是全部、代付款、待收货、已完成、已取消几个状态，同时就是对订单购买的商品标题进行模糊搜索



此时怎么分页？你的索引映射表里，只有（userid, orderid）。但这又怎样，你完全可以在这个索引映射表里加入更多的数据，比如（userid, orderid, order_status, product_description），加上订单所处的状态，以及商品的标题。副标题等文本



然后你在对「我的订单」进行分页的时候，直接就可以根据 userid 去索引映射表里找到用户的所有订单，然后按照订单状态、商品描述文本模糊匹配去搜索，完了再分页，分页拿到的 orderid，再去获取订单需要展示的数据。



如果是针对运营端的分页查询需求呢？数据直接进入 ES 里，通过 ES 就可以对多条进行搜索同时再进行分页



当然，也有人说过一些跨库的分页方案。比如说要针对跨多个库和多个表的数据搞查询和分页，基本上只能是自己从各个库表拉数据到内存，自己内存里做筛选和分页了。或者是基于数据库中间件去做，数据库中间件本质也是干这个，把各个库表的数据拉到内存做筛选和分页



实际上这种方案的效率和性能都是极差的，基本都是几秒级别的速度。所以当你觉得似乎要跨库和表查询分页的时候，建议，第一，是不是可以把你查询里按照某个主要的业务 id 进行分库分表建立一个索引映射表；第二，是不是可以把这个查询里要的条件都放到索引映射表里去；第三，是不是可以通过 ES 来搞定这个需求



## 分库分表的扩容

假设分库分表了，比如搞了几个数据库服务器，每个服务器上部署了一个数据库实例，然后你的业务库拆分在各个服务器上，你的业务表拆分为几百上千个，每个服务器上都有一部分。



此时过了几年后，你每个表的数据量都增长到了一定水准。比如刚拆分的时候每个表才 100W 数据，结果过了几年，每个表都增长到了几百万数据，此时怎么办？只能是把表进一步拆分，增加更多的表了。完了增加更多的表后还得把数据做迁移，更改系统的路由规则，极为的麻烦



大家觉得真的应该出现这种情况吗？其实不是，我们应该一开始，就完全可以多分一些表，比如你数据量只有 10 亿级，那么你可以分为 10000 个表，每个表才 10W 数据，而且后续你计算好增量，可能 10 年，20 年过后，单表数据百万级。此时就不会出现上述情况了



所以，从一开始，你的表数量宁愿多一些，也别太少，最好是计算一下数据增量，让自己永远不用增加更多的表



另外，如果过了几年后，你的每一台服务器上的存储空间要耗尽了，或者是写并发压力太大，每个服务器的并发压力都到瓶颈了呢？此时就要增加更多的数据库服务器。增加服务器之后，还要把你的表均匀分散迁移到新增加的数据库服务器上去，然后修改一些系统里的路由规则，用新的路由规则保证你能正确的把数据路由到指定表以及指定库上去就行



因此关于数据库扩容这块，网上虽然有很多方案，但是我们建议及时，刚开始拆分，表数据可以多一些，避免后续要增加表。然后数据库服务器扩容是没问题，直接把表做一下迁移就行了，然后修改路由规则



