---
title: 常见的网络攻击
date: 2020-04-12 17:50:36
tags: 计算机网络
categories: 计算机网络
---

## XSS 攻击

XSS 的全称是 `Cross Site Script`，就是跨站点脚本攻击，意思就是，黑客恶意篡改你的网页的前端代码，在里面注入一些它自己的 html + JavaScript 的脚本和代码，然后在你访问那个网站的网页的时候，他注入的那些恶意脚本就会运行。恶意脚本运行的时候就会控制你的浏览器，这个时候它的脚本就可以做很多的事情了。



### XSS 反射性攻击

第一种 XSS 攻击是反射性攻击，它主要是想办法让你点击一个 URL 链接，在这个 URL 链接里就嵌入它自己的恶意脚本，你点击那个 URL 链接之后，那个 URL 指向的是黑客自己服务器上的一段恶意脚本。



它可能给你展示的是一个图片，或者是一个 flash 动图，亦或是一个小视频的东西，引诱你去点击，然后恶意脚本被返回到你的浏览器里运行，就可以控制你的浏览器里的行为了。这个控制行为就很恐怖了，它可以干很多事情，比如说脚本可以让你自动关注某个用户 id，然后控制你发自动发布一个带有病毒的微博，这是比较简单的。



实际上，一段恶意的 JS 脚本，几乎是无恶不作的。因为它一旦控制你的浏览器就可以得到大量的东西。浏览器一般包含了你的一些 cookie，有的浏览器还可能存储了你的密码，通过知道你的 cookie，就可以利用 cookie 伪造你的用户登录的 session 状态，以你的名义去干一些事情。



### XSS 持久型攻击

另一种 XSS 攻击是叫持久型攻击。举个例子，例如一个论坛，或者社交网站之类的系统，你可以发布一些帖子，或者是评论啥的内容，此时黑客就可以在里面写一段恶意脚本，然后把恶意脚本混杂在评论内容里提交到你的网站数据库里去。



然后后面其他用户在社交网站里浏览到你的评论，评论内容会被返回到浏览器里去，此时评论内容是包含恶意 JS 脚本的。恶意脚本一运行，又可以干坏事了。



### 解决方案

**消毒机制**。就是说，如果黑客在一些评论之类的内容里混入恶意脚本，那么你的代码必须对内容进行消毒，就是进行一些转义。这样就可以把恶意脚本里的 HTML 标签，JS 代码之类的东西，给转义掉，让这些恶意脚本失效。



**HttpOnly 方式**。如果你在浏览器里存放 cookie 的时候，可以设置一个 `HttpOnly` 属性，比如存放用户加密认证消息的 cookie，这样的话，在浏览器里运行的 JS 脚本是被禁止访问这些 HttpOnly cookie 的。他就无法窃取你在浏览器里存储的 cookie 了。



## SQL 注入

系统在数据库里执行 SQL 语句的时候，可能也存在漏洞，导致黑客把一些恶意的 SQL 语句注入进去，让你的系统在你的数据库里执行。例如下面这么一个请求：

```
http://www.xxx.com/goods?goodsSkuNo=xxxxx
```



通过前端传递 `goodsSkuNo` 的数据 "xxxxx"，然后在后台执行这么一条 SQL 语句来查询数据：

```sql
SELECT * FROM eshop_goods_sku WHERE goods_sku_no = 'xxxxx'
```



但是如果后台的 SQL 语句是手动拼接的，那前端传过来的数据有可能就会拼接成如下的 SQL 语句：

```sql
SELECT * FROM eshop_goods_sku WHERE goods_sku_no = 'xxxxx'; drop table eshop_goods_sku;--';
```



这样就直接恶意给你造成删库跑路的效果了。这还不算什么，关键是这种 SQL 语句里可以拼接进入各种支持的 SQL 语法，包括对数据库施加的命令，甚至通过附加一些脚本直接窃取你的数据，都是有可能的。



但是如果要给你搞 SQL 注入，其实也不是那么容易的，因为必须要知道你的数据库表结构才行。一般获取数据库表结构的方式就下面几种：

- 如果你使用的是开源软件，比如开源的博客系统，论坛系统，或者别的什么系统，那么人家自然知道你的表结构了。这种情况是比较少见的。

- 错误回显。就是有时候把系统跑在 web 服务器里，然后程序报错了，结果直接在浏览器页面上显示出来你的异常堆栈信息，包括有错误的 SQL 语句。这就尴尬了，通过这个，黑客就知道你的表结构了。

- 根据你的请求参数的名称，大致推测你的数据库表结构。这个一般不现实。



所以要防止 SQL 注入，一个是别让人家知道你的数据表结构，关闭 web 服务器的错误回显，显示一个 400,500 之类的就可以了。另外，就是要用**预编译**的方式。现在 mybatis、hibernate 都是支持预编译的。



预编译，放到底层的 JDBC 里，就是 `PrepareStatement` 对SQL 进行预编译。如果你给 SQL 的某个参数传入进去的是一个恶意 SQL 语句，人家预编译过后，会让你的恶意 SQL 语句是无法执行的，所以千万不要直接自己用字符串去拼接 SQL 语句。



例如 `INSERT INTO xxx_table(xx, xxx, xx) VALUES(?, ?, ?)` 对这个 SQL 进行预编译，然后把里面各个参数设置进去，此时参数里如果带有恶意 SQL 是不会作为 SQL 去执行的。



在 Mybatis 中。对这个方法比如传进去一个 map 或者是对象，mybatis 会根据你的占位符的变量名字，从你的 map 里或者是对象里提取出来一个一个的参数的值，进行预编译 SQL 的参数值的设置。

```mysql
INSERT INTO xxx_table(xx, xxx,xx) VALUES(#{xx}, #{xxx}, #{xx})
```



这个预编译，就是说把黑客在参数里混进来的 SQL 语句当做一个参数，而绝对不会作为独立的 SQL 语句去执行，这就避免了 SQL 注入攻击了。



## CSRF 攻击

CSRF（Cross Site Request Forgery），跨站点请求伪造。这个就是黑客想办法去伪造你这个用户发送请求到某个系统上去，然后查询你的数据，或者进行转账交易之类的。伪装成你，有很多办法，比如利用 XSS 搞一个恶意脚本让你执行，然后盗取你的浏览器里的 cookie，利用你的 cookie 伪装成你登录的状态，然后去执行一些请求。



防御 CSRF  的方法主要是以下几种：

- **防止 cookie 被窃取**：最根本的，还是防止 cookie 被窃取，可以给你的网站的cookie 设置 `HttpOnly` 属性，禁止别别人的 script 脚本窃取，那么别人就无法伪造用户登录请求了。

- **随机 token**：每次返回一个页面给你的时候，都生成一个随机 token 附加在页面的随机元素里，同时可以在你的 redis 里可以存一下，然后页面发送请求的时候附加随机 token，验证过来才能执行请求，黑客要是用 postman 构造请求就不知道随机 token 是什么了

- **验证码**：页面提交搞一个验证码，那种图形的。现在比较流行的还有拖动一个拼图什么的，必须验证码通过了才能执行你的请求，避免黑客直接伪造请求发送过来，这个其实是比较常见的，最好是在用户进行支付交易的时候，要求必须在页面上拖拽一个拼图验证码

- **Referer请求头**：这个是 http 请求里有一个 referer 请求头，带有这个请求头的来源，你可以验证一下这个请求是不是从自己的页面里来的，如果是的话才执行，否则就不要执行。



## 文件上传可以遭受的攻击

很多时候我们的网站允许别人上传文件，那么文件可能是可执行的脚本，可能是病毒或者木马文件，这个是非常危险的。如果是脚本的话，可能在服务器执行，搞很多破坏，比如黑客黑掉你的服务器，勒索你给他比特币之类的。他们会把自己的文件后缀改成 .jpg、.txt 之类的来上传，其实本质上是病毒文件。



对于文件上传这块，核心就是要进行白名单校验，**限制上传文件的类型**，**而且要限制文件的大小**，**还要对文件重命名**。限制文件类型不能简单地根据后缀来判断，要根据文件二进制数据的开头几个字节代表的 `magic number` 来判断文件的类型。例如 JPEG 的魔数是 FFD8FF；PNG 的魔数是 89504E47。以此类推。



网上可以查到完整的 magic number 列表，根据这个限制一下，哪些文件可以上传，这样就避免木马、病毒之类的可执行文件被上传了。



另外，最好对文件进行一定的压缩，这样可以破坏原来的 文件结构，避免文件在服务器执行。利用 `imagemagick` 这种开源包，可以很方便进行文件缩放。



## DDoS

`DDoS`，distributed denial of service，分布式拒绝服务攻击。可以把你的网站、APP、系统搞瘫痪了。DDos 攻击，就是说黑客知道你的服务器地址了，然后你的系统假设每秒就抗 1000 请求，黑客就以每秒 1000 请求访问你，你的服务器线程资源全部打满，正常用户根本无法发送请求，你的网站就宕机了。甚至他以每秒 1万 请求攻击你的服务器，那你的系统机器就挂了。



`Dos` 攻击是一对一的，就是黑客搞一台高性能服务器，拼命发送请求给你的一台服务器，但是如果你的服务器配置超高，每秒抗 1万 请求，结果黑客的机器才每秒 5000 请求，那么就没用了。



`DDos` 意思就是黑客控制大量的机器，比如普通人的电脑，或者是一些公司的服务器，被他的一些木马植入给控制了，就是所谓的 “肉鸡”，然后黑客下达指令，让所有肉鸡一起发送请求给攻击目标，直接搞瘫你的服务器。



如何防御 DDoS 攻击？如果只靠自己还是挺难的，这其实是非常专业的一种攻击手段，通常我们可以采购云厂商的安全服务，比如 DDoS 高防 IP，可以把攻击流量到导入到云厂商的高防 IP 的服务器上去，他们有专业的技术方案和算法来防御。



### 基于 SYN Flood 模式的 DDoS 攻击

我们简单说一下 TCP 三次握手：

客户端发送一个 `SYN` 请求，指明客户端的端口号以及 TCP 连接的初始序列号

服务器收到 `SYN` 后，返回一个 `SYN` + `ACK`，表示请求被接收，TCP 序列号加 1

客户端收到服务器的 `SYN` + `ACK` 后，返回一个 `ACK` 给服务器，TCP 序列号加 1，连接建立完毕，接着可以通信了。



如果服务器没有收到第三步的 `ACK`，会重试返回 `SYN` + `ACK` 给客户端，同时处于 `SYN_RECV` 状态，把客户端放入等待列表，重试会 3 ~ 5 次，每隔 30 秒重试一次，遍历等待列表，再次重试发送 `SYN` + `ACK`







